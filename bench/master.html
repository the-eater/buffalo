<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bench</title>
    <script src="./TestObject.js"></script>
</head>
<body>
    <script>
        "use strict";
        const worker = new Worker('./worker.js');

        const origin = {
            hello: "no",
            no: 0,
            ye: 0
        };

        let start;
        let stop;
        const TODO = 100000;

        function done(type, value) {
            console.log(`${type} took: ${stop - start}, with: ${value.no} ${value.ye} ${value.hello}`);
        }

        function transform(z) {
            z.no += 1;
            z.hello = "BYeeeee!!!" + z.no;
            z.l = 0;
        }

        function testSimpleObj() {
            let obj = Object.assign({}, origin);

            start = performance.now();
            let todo = TODO;

            worker.onmessage = ({ data }) => {

                todo--;
                if (todo > 0) {
                    transform(data.obj);
                    worker.postMessage({
                        type: 'object',
                        obj: data.obj
                    });
                    return;
                }

                stop = performance.now();
                done("object", data.obj);
            }

            worker.postMessage({
                type: 'object',
                obj: obj
            });
        }

        function testBuffer() {
            let buffer = new ArrayBuffer(TestObject.length);
            let obj = new TestObject(buffer, 0);
            Object.assign(obj, origin);

            start = performance.now();
            let todo = TODO;

            worker.onmessage = ({ data }) => {
                let obj = new TestObject(data.buffer, 0);

                todo--;
                if (todo > 0) {
                    transform(obj);
                    worker.postMessage({
                        type: 'buffer',
                        buffer: data.buffer
                    }, [data.buffer]);
                    return;
                }

                stop = performance.now();
                done("buffer", obj);
            }

            worker.postMessage({
                type: 'buffer',
                buffer: buffer
            }, [buffer]);
        }

        function testSharedBuffer() {
            let buffer = new SharedArrayBuffer(TestObject.length+100);
            let obj = new TestObject(buffer, 0);
            Object.assign(obj, origin);

            start = performance.now();
            let todo = TODO;

            worker.postMessage({
                type: 'shared-buffer-init',
                buffer: buffer
            });

            todo--;
            while (todo > 0) {
                if (obj.l === 1) {
                    transform(obj);
                    todo--;
                 }
            }

            while(obj.l === 0) { }

            stop = performance.now();
            obj.l = 2;
            done("shared-buffer", obj);
        }
    </script>
</body>
</html>
