image: hub.zt.je/docker/node

cache:
  paths:
  - node_modules

stages:
  - lint
  - test
  - build-docs
  - deploy

lint:jshint:
  stage: lint
  script:
    - jshint index.js src lib

test:mocha:
  stage: test
  script:
    - yarn
    - yarn test

test:build-docs:
  stage: build-docs
  variables:
    GIT_STRATEGY: clone
    GIT_CHECKOUT: 'false'
  script:
    - git checkout master
    - yarn
    - yarn build-docs
    - git add docs/api;
    - if ! git diff --quiet -w --staged; then
        git remote set-url origin "https://pusher:${PUSH_TOKEN}@gl.zt.je/eater/buffalo.git";
        git commit -m '[ci skip] Automated docs generation';
        git push;
      fi
  only:
    - master

deploy:github:
  stage: deploy
  variables:
    GIT_STRATEGY: clone
    GIT_CHECKOUT: 'false'
  script:
    - mkdir "/root/.ssh"
    - echo "${DEPLOY_KEY}" > "/root/.ssh/id_rsa"
    - chmod 600 /root/.ssh/id_rsa
    - echo "${HOSTKEY}" > "/root/.ssh/known_hosts"
    - git push -f git@github.com:the-eater/buffalo.git master
  only:
    - master
